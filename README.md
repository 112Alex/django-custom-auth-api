# API Аутентификации и Авторизации на Django

Этот проект представляет собой бэкенд-приложение на Django + DRF, реализующее кастомную систему аутентификации и авторизации. Главная особенность — собственная гибкая RBAC (Role-Based Access Control) система управления правами на уровне базы данных, без жесткой привязки к стандартным группам Django.

*(Комментарии внутри кода написаны на русском языке для пояснения логики реализации, сама документация и названия переменных — на английском).*

## Архитектура прав доступа

Мы выбрали модель RBAC (Role-Based Access Control) за её гибкость и масштабируемость. Это позволяет очень точно настраивать, кто и что может делать в системе.

Схема базы данных состоит из пяти основных моделей:
- **`Resource`**: Сущность, к которой идет обращение (например, "SecretDocument" или "UserProfile").
- **`Action`**: Действие, которое можно совершить (например, "read", "write", "delete").
- **`Permission`**: Связка Ресурса и Действия (например, право "читать SecretDocument").
- **`Role`**: Набор Разрешений (Permission), определяющий роль человека (например, "Admin", "Manager", "Viewer").
- **`CustomUser`**: Модель пользователя. Пользователю назначается одна или несколько Ролей, от которых он наследует все права.

**Как это работает:**
При запросе система проверяет, есть ли у пользователя хотя бы одна роль, которая содержит необходимое разрешение для конкретного действия над ресурсом. Суперпользователи (администраторы) по умолчанию имеют доступ ко всему.

## Установка и запуск

Проект полностью завернут в Docker, так что развернуть его можно одной командой.

**Требования:**
- Docker
- Docker Compose

### 1. Клонирование репозитория
Склонируйте проект к себе на машину:
```bash
git clone https://github.com/USERNAME/REPOSITORY.git
cd REPOSITORY
```

### 2. Настройка окружения
Проект использует `.env` файл для конфигурации. Создайте его из примера:
```bash
cp .env.example .env
```
Значения по умолчанию в `.env.example` вполне подходят для локальной разработки. Для продакшена не забудьте сменить `SECRET_KEY`.

### 3. Сборка и запуск
Выполните команду в корне проекта:
```bash
docker-compose up --build -d
```
Эта команда сделает всё сама:
- Соберет Docker-образы для Django и PostgreSQL.
- Запустит контейнеры в фоновом режиме.
- Накатит миграции базы данных.
- **Автоматически заполнит БД тестовыми данными** (роли, права, админ) через скрипт `seed_db`.

После этого API будет доступно по адресу `http://localhost:8000`.

### Тестовый Админ
При первом запуске скрипт сидинга создает суперюзера, чтобы вы могли сразу проверить работу:
- **Email**: `admin@example.com`
- **Password**: `adminpassword`

## Документация API
К проекту прикручен `drf-yasg`, так что полная спецификация доступна в браузере:
- **Swagger UI**: `http://localhost:8000/swagger/`
- **ReDoc**: `http://localhost:8000/redoc/`

## Запуск тестов
В проекте есть набор тестов. Чтобы прогнать их внутри контейнера, используйте команду:
```bash
docker-compose exec web python src/manage.py test core
```
Это запустит тесты в том же окружении, где работает приложение. CI пайплайн (в `.github/workflows/ci.yml`) также гоняет эти тесты при каждом пуше в `main`.

## Примеры использования (cURL)
Ниже несколько примеров, как дергать API через консоль.

#### 1. Регистрация нового пользователя
```bash
curl -X POST http://localhost:8000/api/register/ \
-H "Content-Type: application/json" \
-d '{"email": "newuser@example.com", "password": "strongpassword", "password2": "strongpassword"}'
```

#### 2. Логин (Вход)
В ответ придут `access` и `refresh` токены.
```bash
curl -X POST http://localhost:8000/api/login/ \
-H "Content-Type: application/json" \
-d '{"email": "newuser@example.com", "password": "strongpassword"}'
```

#### 3. Доступ к защищенному ресурсу
Подставьте полученный `access` токен.
```bash
ACCESS_TOKEN="ваш_токен_тут"
curl -X GET http://localhost:8000/api/secret/ \
-H "Authorization: Bearer $ACCESS_TOKEN"
```

#### 4. Логаут (Выход)
Эта ручка добавляет refresh-токен в черный список. Требует авторизации.
```bash
ACCESS_TOKEN="ваш_access_токен"
REFRESH_TOKEN="ваш_refresh_токен"
curl -X POST http://localhost:8000/api/logout/ \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Content-Type: application/json" \
-d '{"refresh": "'$REFRESH_TOKEN'"}'
```

#### 5. Управление ролями (Только Админ)
Зайдите под админом (см. раздел "Тестовый Админ"), получите токен и дергайте ручки управления правами.
```bash
ADMIN_ACCESS_TOKEN="токен_админа"
curl -X GET http://localhost:8000/api/admin/roles/ \
-H "Authorization: Bearer $ADMIN_ACCESS_TOKEN"
```